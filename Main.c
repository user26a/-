/*********************************************************************************************************
* 模块名称: Main.c
* 摘    要: 主文件，包含软硬件初始化以及main函数
* 当前版本: 1.0.0
* 作    者: SZLY(COPYRIGHT 2018 SZLY. All rights reserved.)
* 完成日期: 2018年01月01日
* 内    容:
* 注    意: 注意勾选Options for Target 'Target1'->Code Generation->Use MicroLIB
只实现了50hz工频滤波
pa4产生DAC波形用于测试
pa5用于ADC
**********************************************************************************************************
* 取代版本: 
* 作    者:
* 完成日期: 
* 修改内容: 加入50Hz工频滤波器
* 修改文件: Main.c
*********************************************************************************************************/

/*********************************************************************************************************
*                                              包含头文件
*********************************************************************************************************/
#include <stm32f10x_conf.h>
#include "Main.h"
#include "DataType.h"
#include "Timer.h"
#include "UART1.h"
#include "NVIC.h"
#include "RCC.h"
#include "LED.h"
#include "SysTick.h"
#include "Wave.h"
#include "ProcHostCmd.h"
#include "PackUnpack.h"
#include "SendDataToHost.h"
#include "DAC.h"
#include "ADC.h"

/*********************************************************************************************************
*                                              宏定义
*********************************************************************************************************/
#define FILTER_ORDER 4  // 滤波器阶数 (对应历史值数量)

/*********************************************************************************************************
*                                              内部变量
*********************************************************************************************************/

// 存储历史输入和输出值
static float x_history[3] = {0};  // 输入历史值
static float y_history[3] = {0};  // 输出历史值

// 二阶低通 IIR 滤波器参数
// B系数：前向系数（与输入信号相关）
float IIR_LowPass_B[3] = { 0.2929, 0.5858, 0.2929 };  // 前向系数 (b0, b1, b2)
// A系数：反馈系数（与输出信号相关）
float IIR_LowPass_A[3] = { 1.0, -0.0000, 0.1716 };     // 反馈系数 (a1, a2)

static int Heart_rate_counter;
static int Heart_rate = 0; //计数器

/*********************************************************************************************************
*                                              枚举结构体定义
*********************************************************************************************************/

/*********************************************************************************************************
*                                              内部函数声明
*********************************************************************************************************/
static  void  InitSoftware(void);   //初始化软件相关的模块
static  void  InitHardware(void);   //初始化硬件相关的模块
static  void  Proc2msTask(void);    //处理2ms任务
static  void  Proc1SecTask(void);   //处理1s任务

/*********************************************************************************************************
*                                              内部函数实现
*********************************************************************************************************/

/*********************************************************************************************************
* 函数名称: InitSoftware
* 函数功能: 所有的软件相关的模块初始化函数都放在此函数中
* 输入参数: void
* 输出参数: void
* 返 回 值: void
* 创建日期: 2018年01月01日
* 注    便: 
*********************************************************************************************************/
static  void  InitSoftware(void)
{
    InitPackUnpack();       //初始化打包解包模块
    InitProcHostCmd();      //初始化处理命令模块
    InitSendDataToHost();   //初始化发送命令到上位机
}

/*********************************************************************************************************
* 函数名称: InitHardware
* 函数功能: 所有的硬件相关的模块初始化函数都放在此函数中
* 输入参数: void
* 输出参数: void
* 返 回 值: void
* 创建日期: 2018年01月01日
* 注    便: 
*********************************************************************************************************/
static  void  InitHardware(void)
{
    SystemInit();       //系统初始化
    InitRCC();          //初始化RCC模块
    InitNVIC();         //初始化NVIC模块
    InitUART1(115200);  //初始化UART模块
    InitTimer();        //初始化Timer模块
    InitLED();          //初始化LED模块
    InitSysTick();      //初始化SysTick模块
    InitDAC();
    InitADC();//初始化DAC模块

}

/*********************************************************************************************************
* 函数名称:  带通滤波函数
* 函数功能: 
* 输入参数: void
* 输出参数: void
* 返 回 值: void
* 创建日期: 2024年11月18日
* 注    便: 
*********************************************************************************************************/
float BandPassFilter(float input) {
    // 在函数开始处声明变量
    float output = 0.0;

    // 更新输入历史值
    x_history[2] = x_history[1];
    x_history[1] = x_history[0];
    x_history[0] = input;

    // 更新输出历史值
    y_history[2] = y_history[1];
    y_history[1] = y_history[0];

    // 计算滤波输出
    output = IIR_LowPass_B[0] * x_history[0] 
           + IIR_LowPass_B[1] * x_history[1] 
           + IIR_LowPass_B[2] * x_history[2]
           - IIR_LowPass_A[1] * y_history[1] 
           - IIR_LowPass_A[2] * y_history[2];

    // 存储当前输出值作为下一个时刻的历史值
    y_history[0] = output;

    return output;
}
/*********************************************************************************************************
* 函数名称: Proc2msTask
* 函数功能: 处理2ms任务
* 输入参数: void
* 输出参数: void
* 返 回 值: void
* 创建日期: 2018年01月01日
* 注    便: 
*********************************************************************************************************/
static void Proc2msTask(void)
{
    u16 adcData; //队列数据
    u8 waveData; //波形数据
    u8 uart1RecData; //串口数据

		u16 filteredDataBandPass;     // 带通滤波后的数据
	
    static u8 s_iCnt4 = 0; //计数器
    static u8 s_iPointCnt = 0; //波形数据包的点计数器
    static u8 s_arrWaveData[5] = {0}; //初始化数组

    if (Get2msFlag()) //检查 2ms 标志状态
    {
        if (ReadUART1(&uart1RecData, 1)) //读串口接收数据
        {
            ProcHostCmd(uart1RecData); //处理命令
        }

        s_iCnt4++; //计数增加
        if (s_iCnt4 >= 4) //达到 8ms
        {
            if (ReadADCBuf(&adcData)) //从缓存队列中取出 1 个数据
            {
							// 带通滤波
            filteredDataBandPass = BandPassFilter(adcData);
					//	filteredDataBandPass = adcData;
            // 波形数据发送
            waveData = (filteredDataBandPass * 127) / 409;

            //心率计数判断
            if (waveData > 127)
            {
                Heart_rate_counter++;
            }


            s_arrWaveData[s_iPointCnt] = waveData;
            s_iPointCnt++;
            if (s_iPointCnt >= 5)
            {
                s_iPointCnt = 0;
                SendWaveToHost(s_arrWaveData);
            }
            }
            s_iCnt4 = 0; //准备下次的循环
        }

        LEDFlicker(250);
        Clr2msFlag(); //清除 2ms 标志
    }
}

/*********************************************************************************************************
* 函数名称: Proc1SecTask
* 函数功能: 处理1sec任务
* 输入参数: void
* 输出参数: void
* 返 回 值: void
* 创建日期: 2018年01月01日
* 注    便: 
*********************************************************************************************************/
static  void  Proc1SecTask(void)
{
    static u8 s_iCnt60 = 0; //计数器
    
    if (Get1SecFlag())    //检查1s标志状态
    {
        //printf("This is the first STM32F103 Project, by Zhangsan\r\n");
        s_iCnt60++;
        Heart_rate = (Heart_rate_counter / s_iCnt60) * 60;

         printf("Heart_rate:%d\r\n",Heart_rate);

        if (s_iCnt60 >= 60)
        {
            s_iCnt60 = 0;
            Heart_rate_counter = 0;
        }

        Clr1SecFlag();    //清除标志
    }
}

/*********************************************************************************************************
* 函数名称: main
* 函数功能: 主函数
* 输入参数: void
* 输出参数: void
* 返 回 值: int
* 创建日期: 2018年01月01日
* 注    便: 
*********************************************************************************************************/
int main(void)
{
    InitSoftware();   //初始化软件相关函数
    InitHardware();   //初始化硬件相关函数

    printf("Init System has been finished.\r\n" );  //打印系统状态

    while (1)
    {
        Proc2msTask();  //处理2ms任务
        Proc1SecTask(); //处理1sec任务
    }
}
